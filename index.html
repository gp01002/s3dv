<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>自動 3D 深度感產生器</title>
    <style>
        :root { --accent: #1877f2; --bg: #050505; }
        body {
            margin: 0; background: var(--bg); color: white;
            font-family: sans-serif; display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 100vh; overflow: hidden;
        }
        
        .viewport {
            position: relative; width: 90vw; max-width: 500px;
            perspective: 1000px;
        }
        
        .photo-container {
            position: relative; width: 100%; border-radius: 20px;
            overflow: hidden; background: #111;
            box-shadow: 0 40px 80px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        canvas { width: 100%; display: block; }

        .ui-layer {
            margin-top: 30px; text-align: center; z-index: 10;
        }

        .upload-btn {
            background: var(--accent); color: white; padding: 12px 24px;
            border-radius: 30px; cursor: pointer; display: inline-block;
            font-weight: bold; margin-bottom: 15px;
        }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="viewport" id="vbox">
        <div class="photo-container" id="pc">
            <canvas id="displayCanvas"></canvas>
        </div>
    </div>

    <div class="ui-layer">
        <label class="upload-btn">
            選擇照片產生 3D
            <input type="file" id="imgInput" accept="image/*">
        </label>
        <div>
            <button id="authBtn" style="background:none; border:1px solid #444; color:#888; border-radius:15px; padding:5px 15px; cursor:pointer;">
                啟動陀螺儀感應
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('displayCanvas');
        const ctx = canvas.getContext('2d');
        const pc = document.getElementById('pc');
        let img = new Image();
        let isLoaded = false;

        // 1. 處理圖片上傳
        document.getElementById('imgInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        img.onload = () => {
            // 根據圖片比例調整畫布
            const aspect = img.height / img.width;
            canvas.width = 800; 
            canvas.height = 800 * aspect;
            isLoaded = true;
            render(0.5, 0.5); // 初始化繪製
        };

        // 2. 核心渲染功能
        function render(px, py) {
            if (!isLoaded) return;

            // 清除畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 計算位移 (模擬深度感)
            // 這裡我們假設中心點深度最高，四周最低
            const offsetX = (px - 0.5) * 40; 
            const offsetY = (py - 0.5) * 40;

            // 繪製底圖 (稍微放大以防露出邊緣)
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            // 根據滑鼠位置進行微小的差速位移
            ctx.drawImage(img, -canvas.width/2 - offsetX, -canvas.height/2 - offsetY, canvas.width + 80, canvas.height + 80);
            ctx.restore();

            // 3. 增加 CSS 3D 旋轉感
            const rotY = (px - 0.5) * 25;
            const rotX = (0.5 - py) * 25;
            pc.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg) scale(1.05)`;
        }

        // 3. 互動監聽
        window.onmousemove = (e) => {
            render(e.clientX / window.innerWidth, e.clientY / window.innerHeight);
        };

        // 陀螺儀處理
        document.getElementById('authBtn').onclick = () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(s => {
                    if(s==='granted') window.addEventListener('deviceorientation', handleMotion);
                });
            } else {
                window.addEventListener('deviceorientation', handleMotion);
            }
        };

        function handleMotion(e) {
            const px = Math.max(0, Math.min(1, (e.gamma + 25) / 50));
            const py = Math.max(0, Math.min(1, (e.beta + 25) / 50));
            render(px, py);
        }
        
        // 初始預設圖片
        img.src = "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&w=800&q=80";
    </script>
</body>
</html>
