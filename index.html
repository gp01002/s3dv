<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Facebook 風格 3D 深度感觀賞器</title>
    <style>
        :root { --accent: #1877f2; --bg: #050505; }
        body {
            margin: 0; background: var(--bg); color: white;
            font-family: sans-serif; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow: hidden;
        }
        
        .viewport {
            position: relative; width: 95vw; max-width: 700px;
            margin-top: 40px; perspective: 1500px;
        }
        
        .photo-container {
            position: relative; width: 100%; border-radius: 20px;
            overflow: hidden; background: #000;
            box-shadow: 0 50px 100px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
            will-change: transform;
        }
        
        canvas { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            object-fit: cover; will-change: transform, mask-position;
        }

        /* 關鍵：使用漸層遮罩來平滑銜接左右眼，消除重疊影 */
        #canvasR { 
            z-index: 2; 
            -webkit-mask-image: linear-gradient(to right, transparent 45%, black 55%);
            -webkit-mask-size: 300% 100%;
            -webkit-mask-position: 100% 0;
        }
        #canvasL { z-index: 1; }

        .panel { width: 90%; max-width: 700px; padding: 25px; text-align: center; }
        .thumb-nav { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .thumb-item {
            flex: 0 0 65px; height: 65px; border-radius: 12px;
            border: 2px solid #333; overflow: hidden; cursor: pointer; transition: 0.3s;
        }
        .thumb-item.active { border-color: var(--accent); transform: translateY(-5px); }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; }

        #authBtn {
            padding: 12px 40px; border-radius: 30px; border: none;
            background: var(--accent); color: white; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="viewport" id="vbox">
        <div class="photo-container" id="pc">
            <canvas id="canvasL"></canvas>
            <canvas id="canvasR"></canvas>
        </div>
    </div>

    <div class="panel">
        <div class="thumb-nav" id="thumbNav"></div>
        <div style="margin: 20px 0;">
            <button id="authBtn">啟動 3D 互動</button>
        </div>
    </div>

    <script>
        const cvL = document.getElementById('canvasL');
        const cvR = document.getElementById('canvasR');
        const ctxL = cvL.getContext('2d');
        const ctxR = cvR.getContext('2d');
        const thumbNav = document.getElementById('thumbNav');
        const authBtn = document.getElementById('authBtn');
        const pc = document.getElementById('pc');
        
        let images = [];
        const filenames = ['photo1.jpg', 'photo2.jpg', 'photo3.jpg', 'photo4.jpg', 'photo5.jpg', 'photo6.jpg'];

        window.onload = () => {
            filenames.forEach((name, i) => {
                const img = new Image();
                img.src = name;
                img.onload = () => {
                    images[i] = img;
                    const div = document.createElement('div');
                    div.className = 'thumb-item' + (i===0?' active':'');
                    div.innerHTML = `<img src="${img.src}">`;
                    div.onclick = () => loadPhoto(i);
                    thumbNav.appendChild(div);
                    if (i === 0) loadPhoto(0);
                };
            });
        };

        function loadPhoto(index) {
            const img = images[index];
            const w = img.width / 2;
            const h = img.height;
            cvL.width = cvR.width = w;
            cvL.height = cvR.height = h;
            pc.style.aspectRatio = `${w}/${h}`;
            ctxL.drawImage(img, 0, 0, w, h, 0, 0, w, h);
            ctxR.drawImage(img, w, 0, w, h, 0, 0, w, h);
            document.querySelectorAll('.thumb-item').forEach((t, i) => t.classList.toggle('active', i === index));
            update3D(0.5, 0.5); 
        }

        function update3D(px, py) {
            // 1. 計算透視旋轉 (Facebook 的卡片晃動感)
            const rotY = (px - 0.5) * 15;
            const rotX = (0.5 - py) * 15;
            
            // 2. 核心：位移視差 (Facebook 的深度感關鍵)
            // 當向右轉時，左圖往左推，右圖往右推，拉開深度
            const drift = 50; 
            const moveL = (px - 0.5) * -drift;
            const moveR = (px - 0.5) * drift;

            // 3. 遮罩過渡 (無縫切換，不重疊)
            const maskPos = (1 - px) * 100;
            cvR.style.webkitMaskPosition = `${maskPos}% 0`;

            // 4. 應用變換：結合縮放、旋轉與水平差速位移
            pc.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg) scale(1.15)`;
            cvL.style.transform = `translateX(${moveL}px)`;
            cvR.style.transform = `translateX(${moveR}px)`;
        }

        document.getElementById('vbox').onmousemove = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            update3D((e.clientX - rect.left) / rect.width, (e.clientY - rect.top) / rect.height);
        };

        authBtn.onclick = () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(s => {
                    if(s==='granted') window.addEventListener('deviceorientation', e => {
                        update3D(Math.max(0, Math.min(1, (e.gamma + 20) / 40)), Math.max(0, Math.min(1, (e.beta + 20) / 40)));
                    });
                });
            } else {
                window.addEventListener('deviceorientation', e => {
                    update3D(Math.max(0, Math.min(1, (e.gamma + 20) / 40)), Math.max(0, Math.min(1, (e.beta + 20) / 40)));
                });
            }
            authBtn.style.display = 'none';
        };
    </script>
</body>
</html>
